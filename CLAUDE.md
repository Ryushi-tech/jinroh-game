# CLAUDE.md — 人狼ゲーム プロジェクト憲法

このファイルは、Claude Code がこのリポジトリで作業する際の **最上位ルール** である。
すべての生成・編集作業はこの憲法に従うこと。

---

## 1. 技術スタック

| 役割 | ファイル |
|------|----------|
| ゲーム状態（単一の真実源） | `game_state.json` |
| キャラクター設定マスタ | `characters.json` |
| ロジック実行エンジン | `logic_engine.py` |
| 整合性バリデーター | `validator.py` |

---

## 2. 絶対守るべきルール（破ってはならない）

### 2-1. バリデーション必須
描写（キャラクターの発言を含むテキスト）を **生成・提示する前に**、必ず以下を実行せよ:

```bash
python3 validator.py <描写ファイル>
```

- Exit code 0 → 描写をユーザーに提示してよい
- Exit code 1 → **提示禁止**。エラー内容を確認し、描写を修正して再度バリデーションを通すこと。通るまで繰り返す。

### 2-2. 状態変更の手続き
- プレイヤーの **死亡・役職変更・フェーズ遷移** は、必ず `logic_engine.py` を介して行うこと。
- `game_state.json` を **手動で直接編集してはならない**。

### 2-3. 死人は喋らない
`alive: false` のキャラクターに発言させることは、いかなる場合も禁止。
これはバリデーターでも検出されるが、生成段階で意識して回避せよ。

### 2-4. キャラクターの一貫性
発言を生成する際は、必ず `characters.json` の該当キャラクターを参照し、以下を守ること:
- `speech_style.first_person` — 一人称の統一
- `speech_style.tone` — 口調の維持
- `speech_style.vocal_tics` — 語尾・口癖の反映
- `intellect` — 推理傾向の反映

---

## 3. ゲーム設定

### 3-1. 村の構成（9人村）
| 陣営 | 役職 | 人数 |
|------|------|------|
| 人狼陣営 | 人狼 (werewolf) | 2 |
| 人狼陣営 | 狂人 (madman) | 1 |
| 村人陣営 | 占い師 (seer) | 1 |
| 村人陣営 | 狩人 (bodyguard) | 1 |
| 村人陣営 | 村人 (villager) | 4 |

### 3-2. 勝利条件
- **村人陣営**: 人狼を全員処刑すれば勝利
- **人狼陣営**: 人狼の数 ≧ 村人陣営の生存数 で勝利（狂人は人狼陣営だが人狼にカウントしない）

### 3-3. フェーズ進行
```
night → day_discussion → day_vote → night → ...
```

1. **night（夜）**: 人狼の襲撃先決定、占い師の占い、狩人の護衛（※初夜 Day 0 は全アクション無し。占い・護衛・襲撃いずれも行われない）
2. **day_discussion（昼・議論）**: 全生存者による議論
3. **day_vote（昼・投票）**: 処刑対象の投票・決定

### 3-4. 各役職の能力
- **人狼**: 夜に1人を襲撃（2人で相談して1人を選ぶ）
- **占い師**: 夜に1人を占い、人狼か否かを知る（初夜 Day 0 の占いは無し。Day 1 の夜が最初の占い）
- **狩人**: 夜に1人を護衛し、襲撃から守る（連続同一護衛は不可）
- **狂人**: 特殊能力なし。占い結果は「人狼ではない」。人狼陣営の勝利を目指す
- **村人**: 特殊能力なし。議論と投票で人狼を見つけ出す

### 3-5. 死亡時の情報公開ルール（重要）

**処刑死者:**
- 公開されるのは霊媒結果：**「人狼」か「人間」かのみ**
- 狂人・占い師・狩人・村人はすべて「人間」と判定される
- 具体的な役職（占い師、狩人、狂人 等）は**一切公開されない**

**襲撃死者:**
- 人狼に喰われた＝「人間」であることのみ確定
- 具体的な役職は**一切公開されない**（狩人が襲撃死しても「狩人だった」とは誰にもわからない）

**描写への適用:**
- ナレーションや NPC の台詞で、死者の具体的な役職を明かしてはならない
- NG例: 「正体は占い師だった」「狩人が死んだ」「狂人を吊ってしまった」
- OK例: 「人狼だった」「人間だった」「少なくとも人狼ではなかったようだ」
- player_status.py の表示も「人狼/人間」のみとする

---

## 4. 描写生成のワークフロー

```
1. game_state.json の現在状態を確認する
2. characters.json から該当キャラの設定を読む
3. 描写テキストを生成し、一時ファイルに書き出す
4. python3 validator.py <一時ファイル> を実行する
5. 成功 → ユーザーに提示する
   失敗 → 修正して手順4に戻る
```

---

## 5. ログ記録
`game_state.json` の `log` 配列に、各フェーズで起きたイベントを記録する。
形式:
```json
{
  "day": 1,
  "phase": "night",
  "type": "attack",
  "actor": "モーリッツ",
  "target": "パメラ"
}
```
